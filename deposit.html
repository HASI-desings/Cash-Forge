<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CashForge | Deposit</title>
    
    <!-- FONTS & ICONS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- GLOBAL STYLES -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- DEPOSIT SPECIFIC STYLES --- */
        
        /* Network Selector Cards */
        .net-card {
            border: 1px solid rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.4);
            padding: 16px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .net-card.active {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00FFFF;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.15);
        }
        
        /* Custom Radio Button (Fixed Alignment) */
        .radio-circle {
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #cbd5e1; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; /* Center the dot */
            transition: all 0.2s;
        }
        .net-card.active .radio-circle {
            border-color: #00FFFF;
        }
        .radio-dot {
            width: 10px; height: 10px; background: #00FFFF; border-radius: 50%;
            transform: scale(0); transition: transform 0.2s;
        }
        .net-card.active .radio-dot { transform: scale(1); }

        /* Step Container Transition */
        .step-container {
            display: none;
            animation: slideUp 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .step-container.active { display: block; }

        /* Upload Area */
        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            background: rgba(255,255,255,0.3);
            min-height: 120px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; cursor: pointer;
            position: relative; overflow: hidden;
        }
        .upload-box:hover { border-color: #00FFFF; background: rgba(0,255,255,0.05); }
        .upload-box img {
            width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0;
        }
    </style>
</head>
<body>

    <div class="bg-dots"></div>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <!-- HEADER -->
    <header class="gradient-bar fixed top-0 w-full z-50 h-[70px] flex items-center justify-between px-5 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 flex items-center justify-center rounded-xl bg-gradient-to-br from-cyan-300 to-cyan-500 shadow-lg shadow-cyan-200/50">
                <i class="ph-bold ph-lightning text-white text-xl"></i>
            </div>
            <div>
                <span class="heading-font font-bold text-xl tracking-tight text-slate-800 leading-none block">CashForge</span>
            </div>
        </div>
        <div class="glass-panel px-4 py-1.5 rounded-full flex items-center gap-2 border border-cyan-100 shadow-sm">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <!-- Loading state initially -->
            <span class="heading-font font-bold text-slate-800" id="header-balance">...</span>
        </div>
    </header>

    <!-- CONTENT -->
    <main class="w-full max-w-lg mx-auto px-4 relative z-10 pt-24 pb-24">
        
        <div class="flex items-center justify-between mb-6">
            <h2 class="heading-font text-2xl font-bold text-slate-800">Deposit Funds</h2>
            <div class="text-[10px] font-bold text-slate-400 bg-white/50 px-2 py-1 rounded border border-white">
                Step <span id="step-count">1</span>/2
            </div>
        </div>

        <!-- ================= STEP 1: AMOUNT & NETWORK ================= -->
        <div id="step-1" class="step-container active">
            
            <!-- Calculator Card -->
            <div class="glass-panel rounded-3xl p-6 mb-6">
                <div class="input-group mb-4">
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1 mb-1 block">Deposit Amount (PKR)</label>
                    <input type="number" id="dep-amount" oninput="calcConversion()" placeholder="Min 500 - Max 999,999" class="input-glass text-lg font-bold">
                </div>

                <div class="bg-cyan-50 rounded-2xl p-4 border border-cyan-100 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">You Will Pay</p>
                        <!-- Updated Logic: Shows USDT to pay -->
                        <p class="font-mono text-xl font-bold text-slate-800" id="display-pay">0.00 USDT</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">You Receive</p>
                        <!-- Updated Logic: Shows PKR Received -->
                        <p class="font-mono text-xl font-bold text-brand-dark" id="display-receive">₨ 0</p>
                    </div>
                </div>
                <p class="text-center text-[10px] text-slate-400 mt-2 font-mono">Current Rate: 1 USDT = 285 PKR</p>
            </div>

            <!-- Network Selection -->
            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3 ml-2">Select Network</h3>
            <div class="space-y-3 mb-8">
                <div class="net-card active" onclick="selectNetwork('TRC20', this)">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-500 border border-red-100">
                            <i class="ph-bold ph-asterisk-simple text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">USDT (TRC20)</h4>
                            <p class="text-[10px] text-slate-400">Tron Network • 1-3 Mins</p>
                        </div>
                    </div>
                    <!-- Fixed Radio Circle -->
                    <div class="radio-circle"><div class="radio-dot"></div></div>
                </div>

                <div class="net-card" onclick="selectNetwork('BEP20', this)">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600 border border-yellow-100">
                            <i class="ph-bold ph-diamond text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">USDT (BEP20)</h4>
                            <p class="text-[10px] text-slate-400">BNB Smart Chain • 1-2 Mins</p>
                        </div>
                    </div>
                    <!-- Fixed Radio Circle -->
                    <div class="radio-circle"><div class="radio-dot"></div></div>
                </div>
            </div>

            <button onclick="goToStep2()" class="w-full py-4 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-[0.98] transition-transform flex items-center justify-center gap-2">
                Continue to Payment <i class="ph-bold ph-arrow-right"></i>
            </button>
        </div>

        <!-- ================= STEP 2: ADDRESS & PROOF ================= -->
        <div id="step-2" class="step-container">
            
            <!-- Address Card -->
            <div class="glass-panel rounded-3xl p-6 mb-6 text-center">
                <p class="text-xs text-slate-500 mb-4">Scan QR code or copy address below</p>
                
                <div class="mx-auto w-fit p-3 bg-white rounded-2xl shadow-sm mb-4 border border-slate-100">
                    <img src="" alt="QR Code" class="w-32 h-32 rounded-lg" id="qr-image">
                </div>

                <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 flex items-center justify-between gap-2">
                    <p class="text-[10px] font-mono text-slate-600 truncate flex-1" id="wallet-address">Loading...</p>
                    <button onclick="copyAddress()" class="p-2 bg-white rounded-lg shadow-sm text-brand-dark hover:scale-110 transition">
                        <i class="ph-bold ph-copy"></i>
                    </button>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-left">
                    <p class="text-[10px] text-yellow-700 leading-relaxed">
                        <i class="ph-fill ph-warning-circle mr-1"></i>
                        Send exactly <strong id="confirm-amount">...</strong> USDT. Only send <span id="confirm-network">...</span> network assets. Other assets will be lost forever.
                    </p>
                </div>
            </div>

            <!-- Proof Form -->
            <div class="glass-panel rounded-3xl p-6">
                <h3 class="text-sm font-bold text-slate-800 mb-4">Submit Proof</h3>
                
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Transaction ID (Hash)</label>
                    <input type="text" id="tx-id" placeholder="Paste Transaction ID here" class="input-glass">
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Upload Screenshot</label>
                    <div class="upload-box" onclick="document.getElementById('file-upload').click()">
                        <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="previewImage(event)">
                        <div id="upload-placeholder" class="text-center">
                            <i class="ph-duotone ph-image text-3xl text-slate-300 mb-2"></i>
                            <p class="text-xs text-slate-500 font-medium">Tap to Upload</p>
                        </div>
                        <img id="image-preview" class="hidden">
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="goBackStep1()" class="flex-1 py-3 rounded-xl border border-slate-300 text-slate-600 font-bold text-sm">Back</button>
                    <button onclick="submitDeposit()" class="flex-[2] py-3 rounded-xl bg-gradient-to-r from-cyan-400 to-cyan-500 text-white font-bold text-sm shadow-lg shadow-cyan-200/50">Submit Request</button>
                </div>
            </div>

        </div>

    </main>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- NAVIGATION BAR -->
    <nav class="gradient-bar fixed bottom-0 w-full z-50 h-[80px] shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-end h-full max-w-lg mx-auto pb-4">
            <a href="home.html" class="nav-item flex flex-col items-center group w-16">
                <div class="nav-icon-box"><i class="ph-bold ph-house nav-icon"></i></div><span class="nav-text">Home</span>
            </a>
            <a href="tasks.html" class="nav-item flex flex-col items-center group w-16">
                <div class="nav-icon-box"><i class="ph-bold ph-list-checks nav-icon"></i></div><span class="nav-text">Tasks</span>
            </a>
            <a href="trade.html" class="nav-item flex flex-col items-center group w-16">
                <div class="nav-icon-box"><i class="ph-bold ph-chart-line-up nav-icon"></i></div><span class="nav-text">Trade</span>
            </a>
            <a href="teams.html" class="nav-item flex flex-col items-center group w-16">
                <div class="nav-icon-box"><i class="ph-bold ph-users-three nav-icon"></i></div><span class="nav-text">Team</span>
            </a>
            <a href="profile.html" class="nav-item active flex flex-col items-center group w-16">
                <div class="nav-icon-box"><i class="ph-bold ph-user-circle nav-icon"></i></div><span class="nav-text">Profile</span>
            </a>
        </div>
    </nav>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { Auth } from './assets/js/auth.js';
        import { DB } from './assets/js/db.js';
        import { UI } from './assets/js/ui.js';

        // CONSTANTS
        const RATE = 285;
        const MIN_DEPOSIT_PKR = 500;
        const MAX_DEPOSIT_PKR = 999999;
        const WALLETS = {
            'TRC20': 'TAjyw8fVP8dkXJjqFE3vNMBWGaNz5sRbeG',
            'BEP20': '0x216c7d58c3F07428D3c1Be3762F402f71b43Eb56'
        };

        let state = {
            amountPKR: 0,
            amountUSDT: 0,
            network: 'TRC20',
            balance: 0
        };

        const formatCurrency = (val) => '₨ ' + parseFloat(val).toLocaleString();

        // --- INITIALIZATION ---
        window.onload = async () => {
            const user = await Auth.getCurrentUser();
            
            if (user) {
                const profile = await DB.getProfile(user.id);
                if (profile) {
                    state.balance = profile.balance;
                    document.getElementById('header-balance').innerText = formatCurrency(state.balance);
                }
            }
        };

        // --- CALCULATOR LOGIC ---
        window.calcConversion = () => {
            const input = document.getElementById('dep-amount');
            let val = parseFloat(input.value);
            
            // Max Limit Logic
            if (val > MAX_DEPOSIT_PKR) {
                val = MAX_DEPOSIT_PKR;
                input.value = MAX_DEPOSIT_PKR;
                UI.showToast("Maximum deposit limit reached", "error");
            }
            
            if (isNaN(val) || val < 0) val = 0;
            
            state.amountPKR = val;
            state.amountUSDT = (val / RATE).toFixed(2);

            document.getElementById('display-pay').innerText = state.amountUSDT + ' USDT';
            document.getElementById('display-receive').innerText = formatCurrency(val);
        };

        // --- UI LOGIC ---
        window.selectNetwork = (net, card) => {
            state.network = net;
            document.querySelectorAll('.net-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
        };

        window.goToStep2 = () => {
            if (state.amountPKR < MIN_DEPOSIT_PKR) {
                UI.showToast(`Minimum deposit is ${formatCurrency(MIN_DEPOSIT_PKR)}`, 'error');
                return;
            }
            
            const address = WALLETS[state.network];
            document.getElementById('wallet-address').innerText = address;
            document.getElementById('confirm-amount').innerText = state.amountUSDT;
            document.getElementById('confirm-network').innerText = state.network;
            document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${address}`;

            document.getElementById('step-1').classList.remove('active');
            setTimeout(() => {
                document.getElementById('step-2').classList.add('active');
                document.getElementById('step-count').innerText = "2";
            }, 50);
        };

        window.goBackStep1 = () => {
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-1').classList.add('active');
            document.getElementById('step-count').innerText = "1";
        };

        window.copyAddress = () => {
            const addr = document.getElementById('wallet-address').innerText;
            navigator.clipboard.writeText(addr);
            UI.showToast("Address Copied!", "success");
            if(navigator.vibrate) navigator.vibrate(50);
        };

        window.previewImage = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('upload-placeholder').classList.add('hidden');
                    const img = document.getElementById('image-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        // --- SUBMISSION ---
        window.submitDeposit = async () => {
            const txId = document.getElementById('tx-id').value;
            const file = document.getElementById('file-upload').files[0];

            if (!txId) return UI.showToast("Enter Transaction ID", "error");
            if (!file) return UI.showToast("Upload Proof Screenshot", "error");

            const btn = event.currentTarget;
            const oldText = btn.innerText;
            btn.innerHTML = `<div class="loader-spinner w-5 h-5 border-white"></div>`;
            
            try {
                const user = await Auth.getCurrentUser();
                const result = await DB.createTransaction(
                    user.id,
                    'deposit',
                    state.amountPKR,
                    `${state.network} | ${txId}`,
                    'pending',
                    file // Pass file object
                );

                if (result.success) {
                    UI.showToast("Deposit Submitted!", "success");
                    setTimeout(() => window.location.href = 'profile.html', 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                UI.showToast(error.message, "error");
                btn.innerHTML = oldText;
            }
        };
    </script>
</body>
</html>