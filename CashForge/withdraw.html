<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CashForge | Withdrawal</title>
    
    <!-- FONTS & ICONS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- GLOBAL STYLES -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- TAILWIND -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- WITHDRAW SPECIFIC STYLES --- */
        
        /* Preset Buttons */
        .preset-btn {
            background: rgba(255, 255, 255, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.8);
            padding: 16px 0; 
            border-radius: 16px; 
            font-weight: 700; 
            color: #1e293b; 
            font-family: 'Space Grotesk', sans-serif;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            overflow: hidden;
        }
        .preset-btn:active { transform: scale(0.96); }
        .preset-btn.active {
            background: linear-gradient(135deg, #00FFFF, #06b6d4); 
            border-color: transparent;
            color: white; 
            box-shadow: 0 8px 20px -4px rgba(6, 182, 212, 0.4); 
            transform: translateY(-2px);
        }
        
        /* Wallet Selector */
        .wallet-option {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px;
            border: 1px solid transparent; transition: all 0.2s; cursor: pointer;
            background: rgba(255,255,255,0.4);
        }
        .wallet-option.selected {
            background: rgba(0, 255, 255, 0.1); border-color: #00FFFF;
        }
        .radio-circle {
            width: 18px; height: 18px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center;
        }
        .wallet-option.selected .radio-circle { border-color: #008b8b; }
        .wallet-option.selected .radio-circle::after {
            content: ''; width: 10px; height: 10px; background: #008b8b; border-radius: 50%;
        }

        /* Overlays */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px);
            z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        /* Security Keypad */
        .keypad-btn {
            width: 68px; height: 68px; border-radius: 50%; font-size: 24px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); color: white; transition: all 0.1s; cursor: pointer; user-select: none;
        }
        .keypad-btn:active { background: #00FFFF; color: #1e293b; }
        
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #64748b; transition: all 0.2s; }
        .pin-dot.filled { background: #00FFFF; border-color: #00FFFF; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,255,255,0.5); }
    </style>
</head>
<body>

    <div class="bg-dots"></div>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <!-- HEADER (Injected by components.js) -->
    <!-- Placeholder for visual editing, removed by JS in production -->
    
    <!-- CONTENT -->
    <main class="w-full max-w-lg mx-auto px-4 relative z-10 pt-24 pb-24">
        
        <div class="flex items-center justify-between mb-6">
            <h2 class="heading-font text-2xl font-bold text-slate-800">Withdraw</h2>
            <div id="market-badge" class="flex items-center gap-1 bg-green-50 px-2 py-1 rounded text-[10px] font-bold text-green-700 border border-green-200">
                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div> ELIGIBLE
            </div>
        </div>

        <!-- WALLET SELECTION -->
        <div class="glass-panel rounded-2xl p-5 mb-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Select Wallet</h3>
                <button onclick="window.location.href='settings.html'" class="text-[10px] font-bold text-cyan-600 hover:underline">+ Add New</button>
            </div>
            
            <div class="space-y-2" id="wallet-list">
                <!-- Injected via JS -->
                <div class="text-center p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300 text-slate-400 text-xs">
                    <i class="ph-bold ph-wallet text-xl mb-1 block"></i>
                    Loading wallets...
                </div>
            </div>
        </div>

        <!-- PRESET AMOUNT GRID -->
        <div class="mb-4">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 pl-1">Select Amount (PKR)</h3>
            <div class="grid grid-cols-3 gap-3" id="preset-grid">
                <!-- Buttons injected via JS -->
            </div>
        </div>

        <!-- SUMMARY CARD -->
        <div class="glass-panel rounded-2xl p-5 mb-6 border-l-4 border-cyan-400">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-slate-500">Withdrawal Amount</span>
                <span class="font-bold text-slate-800" id="summary-amount">--</span>
            </div>
            <div class="flex justify-between text-sm mb-3">
                <span class="text-slate-500">Fee (7%)</span>
                <span class="font-bold text-red-400" id="summary-fee">--</span>
            </div>
            <div class="border-t border-slate-200 pt-2 flex justify-between items-center">
                <span class="text-sm font-bold text-slate-600">You Receive</span>
                <span class="heading-font text-2xl font-bold text-brand-dark" id="summary-total">₨ 0</span>
            </div>
        </div>

        <button onclick="initiateWithdraw()" class="w-full py-4 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-[0.98] transition-transform flex items-center justify-center gap-2 mb-8">
            <i class="ph-bold ph-shield-check"></i> Confirm Request
        </button>

    </main>

    <!-- === MARKET CLOSED OVERLAY (For Weekends or Non-Package Days) === -->
    <div id="lock-overlay" class="modal-overlay">
        <div class="bg-white rounded-3xl p-8 text-center max-w-xs shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-red-500"></div>
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-duotone ph-lock-key text-3xl text-slate-400"></i>
            </div>
            <h3 class="heading-font text-xl font-bold text-slate-800 mb-2">Withdrawal Locked</h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed" id="lock-message">
                Your plan does not allow withdrawals today.
            </p>
            <div class="text-xs font-mono bg-slate-50 p-2 rounded text-slate-400 border border-slate-100" id="lock-sub">
                Next Open: ...
            </div>
        </div>
    </div>

    <!-- === PIN PAD OVERLAY === -->
    <div id="pin-overlay" class="modal-overlay">
        <h3 class="text-white font-bold text-xl mb-2">Security Check</h3>
        <p class="text-slate-400 text-xs mb-8">Enter your 6-digit transaction PIN</p>
        
        <div class="flex gap-4 mb-10">
            <div class="pin-dot" id="dot-1"></div><div class="pin-dot" id="dot-2"></div><div class="pin-dot" id="dot-3"></div>
            <div class="pin-dot" id="dot-4"></div><div class="pin-dot" id="dot-5"></div><div class="pin-dot" id="dot-6"></div>
        </div>
        
        <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="keypad-btn" onclick="enterDigit(1)">1</div><div class="keypad-btn" onclick="enterDigit(2)">2</div><div class="keypad-btn" onclick="enterDigit(3)">3</div>
            <div class="keypad-btn" onclick="enterDigit(4)">4</div><div class="keypad-btn" onclick="enterDigit(5)">5</div><div class="keypad-btn" onclick="enterDigit(6)">6</div>
            <div class="keypad-btn" onclick="enterDigit(7)">7</div><div class="keypad-btn" onclick="enterDigit(8)">8</div><div class="keypad-btn" onclick="enterDigit(9)">9</div>
            <div class="keypad-btn" onclick="closePin()"><i class="ph-bold ph-x text-red-400"></i></div>
            <div class="keypad-btn" onclick="enterDigit(0)">0</div>
            <div class="keypad-btn" onclick="backspace()"><i class="ph-bold ph-backspace text-slate-400"></i></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- LOGIC -->
    <script type="module">
        import { CONFIG } from './assets/js/config.js';
        import { Logic } from './assets/js/logic.js';
        import { DB } from './assets/js/db.js';
        import { Auth } from './assets/js/auth.js';
        import { Components } from './assets/js/components.js';
        import { UI } from './assets/js/ui.js';

        let state = {
            balance: 0,
            wallets: [],
            userPackageId: 0, // Fetched from DB
            selectedAmount: 0,
            selectedWallet: null,
            pinAttempt: ""
        };

        const formatCurrency = (val) => '₨ ' + val.toLocaleString();

        window.onload = async () => {
            Components.init(); // Inject Nav & Header
            
            // Real DB Fetch
            const user = await Auth.getCurrentUser();
            if(user) {
                const profile = await DB.getProfile(user.id);
                if (profile) {
                    state.balance = profile.balance;
                    state.userPackageId = profile.active_package_id;
                    // Check if locked immediately
                    checkEligibility();
                }
                
                // Fetch Wallets
                const wallets = await DB.getWallets(user.id);
                state.wallets = wallets || [];
                
                renderPresets();
                renderWallets();
            }
        };

        function checkEligibility() {
            const check = Logic.checkWithdrawalEligibility(state.userPackageId);
            
            if (!check.allowed) {
                document.getElementById('lock-overlay').classList.add('active');
                document.getElementById('lock-message').innerText = check.reason;
                
                // Find the package to show the allowed day
                const pkg = CONFIG.PACKAGES.find(p => p.id === state.userPackageId);
                if (pkg) {
                    document.getElementById('lock-sub').innerText = `Allowed Day: ${pkg.dayName}`;
                } else {
                    document.getElementById('lock-sub').innerText = "Purchase a plan to unlock withdrawals.";
                }

                // Update Badge
                const badge = document.getElementById('market-badge');
                badge.className = "flex items-center gap-1 bg-red-50 px-2 py-1 rounded text-[10px] font-bold text-red-700 border border-red-200";
                badge.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> LOCKED`;
            }
        }

        // --- 2. RENDERERS ---
        function renderPresets() {
            const grid = document.getElementById('preset-grid');
            grid.innerHTML = '';
            CONFIG.WITHDRAW_PRESETS.forEach(amt => {
                const btn = document.createElement('button');
                btn.className = `preset-btn ${state.selectedAmount === amt ? 'active' : ''}`;
                btn.innerText = formatCurrency(amt);
                btn.onclick = () => selectAmount(amt, btn);
                grid.appendChild(btn);
            });
        }

        function renderWallets() {
            const list = document.getElementById('wallet-list');
            if(state.wallets.length === 0) {
                list.innerHTML = `
                    <div class="text-center p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300 text-slate-400 text-xs cursor-pointer hover:bg-slate-50 transition" onclick="window.location.href='settings.html'">
                        <i class="ph-bold ph-wallet text-xl mb-1 block"></i>
                        No wallets found. Click to Add.
                    </div>`;
                return;
            }
            list.innerHTML = '';
            state.wallets.forEach(w => {
                const isActive = state.selectedWallet === w.id ? 'selected' : '';
                const html = `
                    <div onclick="selectWallet('${w.id}')" class="wallet-option ${isActive}" id="wallet-${w.id}">
                        <div class="radio-circle"></div>
                        <div>
                            <p class="text-sm font-bold text-slate-700">${w.label}</p>
                            <p class="text-[10px] font-mono text-slate-400">${w.address}</p>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- 3. ACTIONS ---
        window.selectAmount = (amount, btnElement) => {
            state.selectedAmount = amount;
            
            // Update Buttons Visually
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // Calculate Math
            const fee = amount * CONFIG.ECONOMY.WITHDRAWAL_FEE;
            const total = amount - fee;

            document.getElementById('summary-amount').innerText = formatCurrency(amount);
            document.getElementById('summary-fee').innerText = `- ${formatCurrency(fee)}`;
            document.getElementById('summary-total').innerText = formatCurrency(total);
        }

        window.selectWallet = (id) => {
            state.selectedWallet = id;
            document.querySelectorAll('.wallet-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(`wallet-${id}`).classList.add('selected');
        }

        window.initiateWithdraw = () => {
             // Validation via Logic Engine
             const validCheck = Logic.validateWithdrawal(state.selectedAmount, state.balance, "MOCK_PIN_CHECK", state.userPackageId); 
             
             // Specific checks handled by Logic, but UI checks here for clarity
             if (state.selectedAmount === 0) return UI.showToast("Please select an amount", "error");
             if (!state.selectedWallet) return UI.showToast("Select a wallet address", "error");
             
             if(!validCheck.valid) return UI.showToast(validCheck.msg, "error");
             
             // Show PIN Pad
             document.getElementById('pin-overlay').classList.add('active');
             state.pinAttempt = "";
             updatePinDots();
        }

        // --- 4. PIN PAD LOGIC ---
        window.enterDigit = (num) => {
            if (state.pinAttempt.length < 6) {
                state.pinAttempt += num.toString();
                updatePinDots();
                if (state.pinAttempt.length === 6) verifyPin();
            }
        }

        window.backspace = () => {
            state.pinAttempt = state.pinAttempt.slice(0, -1);
            updatePinDots();
        }

        function updatePinDots() {
            for(let i=1; i<=6; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if(i <= state.pinAttempt.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            }
        }

        window.closePin = () => {
            document.getElementById('pin-overlay').classList.remove('active');
        }

        async function verifyPin() {
            // In production, we verify against DB hash
            // For now, assume success or check against mock
            // await DB.verifyPin(state.pinAttempt)...

            window.closePin();
            UI.showToast("Withdrawal Submitted!", "success");
            
            // Deduct Balance immediately in UI
            state.balance -= state.selectedAmount;
            // Notify components to update header
            // DB.updateBalance(...) called here in real app
        }
    </script>
</body>
</html>
