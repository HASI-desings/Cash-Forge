<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Withdraw Funds | CashForge</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="assets/css/core.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/layout.css">

    <script src="assets/js/supabase.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/db.js"></script>
    <script src="assets/js/finance.js"></script>
    <script src="assets/js/state.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/transition.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await State.init(); 

            const user = State.get('user');
            if (!user) return; // Should be handled by Auth.checkProtection, but safe guard.

            const amountInput = document.getElementById('amount-pkr');
            const withdrawForm = document.getElementById('withdraw-form');
            const withdrawBtn = document.getElementById('withdraw-btn');
            const availableBalanceDisplay = document.getElementById('available-balance');
            
            // Fee and Net Payout Displays
            const feeDisplay = document.getElementById('fee-display');
            const netReceivedDisplay = document.getElementById('net-received-display');
            const minWithdrawWarning = document.getElementById('min-withdraw-warning');
            
            // Bank Binding Check
            const isBankBound = user.bank_account_info && user.bank_account_info.account_number;
            const bankWarning = document.getElementById('bank-bind-warning');

            // Set initial state
            availableBalanceDisplay.innerText = CONFIG.formatCurrency(user.balance);
            if (!isBankBound) {
                bankWarning.classList.remove('hidden');
                withdrawBtn.disabled = true;
            } else {
                bankWarning.classList.add('hidden');
            }

            // --- Calculation Logic ---
            const updateCalculation = () => {
                const pkr = parseFloat(amountInput.value) || 0;
                const result = FinanceManager.calculateWithdrawal(pkr);
                const isSufficient = pkr <= user.balance;

                // Show/Hide warning based on MIN_WITHDRAWAL threshold and balance
                if (pkr < CONFIG.MIN_WITHDRAWAL && pkr > 0) {
                    minWithdrawWarning.innerText = `Minimum withdrawal is ${CONFIG.CURRENCY_SYMBOL} ${CONFIG.MIN_WITHDRAWAL}.`;
                    minWithdrawWarning.classList.remove('hidden');
                    withdrawBtn.disabled = true;
                } else if (!isSufficient) {
                    minWithdrawWarning.innerText = `Insufficient funds. Available: ${CONFIG.CURRENCY_SYMBOL} ${CONFIG.formatCurrency(user.balance)}`;
                    minWithdrawWarning.classList.remove('hidden');
                    withdrawBtn.disabled = true;
                } else if (isBankBound) {
                    minWithdrawWarning.classList.add('hidden');
                    withdrawBtn.disabled = false;
                }
                
                // Update displays
                feeDisplay.innerText = CONFIG.formatCurrency(result.fee);
                netReceivedDisplay.innerText = CONFIG.formatCurrency(result.netReceived);
            };

            amountInput.addEventListener('input', updateCalculation);
            updateCalculation(); // Initial run

            // --- Preset Button Logic ---
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    amountInput.value = btn.dataset.amount;
                    updateCalculation();
                });
            });

            // --- Form Submission ---
            withdrawForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const pkrAmount = parseFloat(amountInput.value);
                const netReceived = parseFloat(netReceivedDisplay.innerText.replace(/,/g, ''));
                
                if (pkrAmount < CONFIG.MIN_WITHDRAWAL || pkrAmount > user.balance) {
                    alert("Invalid amount or insufficient balance.");
                    return;
                }

                if (!confirm(`Confirm withdrawal of ${CONFIG.CURRENCY_SYMBOL} ${CONFIG.formatCurrency(pkrAmount)}? You will receive ${CONFIG.CURRENCY_SYMBOL} ${CONFIG.formatCurrency(netReceived)}.`)) {
                    return;
                }

                withdrawBtn.disabled = true;
                withdrawBtn.innerHTML = '<span class="spinner w-5 h-5 border-2 mx-auto"></span> Processing Request...';

                // 1. Deduct balance first
                const deductionResult = await DB.updateBalance(
                    -pkrAmount, 
                    'withdraw', 
                    { net_payout: netReceived, fee_applied: CONFIG.WITHDRAWAL_FEE }
                );

                if (deductionResult.success) {
                    alert(`Withdrawal of ${CONFIG.CURRENCY_SYMBOL} ${CONFIG.formatCurrency(pkrAmount)} submitted and deducted. Net payout: ${CONFIG.CURRENCY_SYMBOL} ${CONFIG.formatCurrency(netReceived)}. Funds will be credited to your linked bank account soon.`);
                    PageTransition.exitAndRedirect('wallet.html');
                } else {
                    alert(`Withdrawal failed: ${deductionResult.msg || 'Database error.'}`);
                    withdrawBtn.disabled = false;
                    withdrawBtn.innerHTML = 'Request Withdrawal';
                }
            });
        });
    </script>
</head>
<body class="page-enter">
    <div class="app-container">
        <header class="app-header content-padding h-16 flex items-center justify-between">
            <a href="wallet.html" data-transition class="flex items-center text-slate-500 hover:text-cyan-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </a>
            <h1 class="font-bold text-lg text-slate-800 font-display">Withdraw Funds</h1>
            <img src="assets/img/logo.svg" alt="CashForge Logo" class="app-logo h-6 w-auto opacity-70">
        </header>

        <main class="pb-safe pt-20">
            <form id="withdraw-form" class="content-padding">
                
                <section class="section-gap white-card p-5 row-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500">Current Balance</p>
                        <h2 class="text-3xl font-extrabold text-slate-800 mt-1">
                            ${CONFIG.CURRENCY_SYMBOL} <span id="available-balance">0.00</span>
                        </h2>
                    </div>
                    <a href="bank-bind.html" data-transition class="text-xs text-cyan-600 font-semibold row-start gap-1">
                        Bank Details
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </a>
                </section>

                <div id="bank-bind-warning" class="hidden bg-red-50 text-red-700 p-3 rounded-xl mb-4 text-sm font-medium transition-all duration-300">
                    ⚠️ Withdrawal is disabled until a bank account is <a href="bank-bind.html" data-transition class="underline">linked for payout</a>.
                </div>

                <section class="section-gap white-card p-5">
                    <h2 class="text-xs font-bold uppercase text-slate-500 tracking-wider mb-3">1. Requested Amount (PKR)</h2>

                    <div class="mb-4">
                        <label for="amount-pkr" class="form-label">Amount to Withdraw</label>
                        <input type="number" id="amount-pkr" class="form-input text-lg font-bold" placeholder="Min. 1000" required>
                        <p id="min-withdraw-warning" class="hidden text-xs text-red-500 mt-1">Warning Placeholder</p>
                    </div>

                    <div class="layout-grid-4 text-center text-xs font-semibold gap-2">
                        <script>
                            CONFIG.WITHDRAWAL_PRESETS.slice(0, 8).forEach(amount => {
                                document.write(`
                                    <button type="button" class="preset-btn p-2 rounded-xl bg-slate-50 border border-slate-200 text-slate-600 active:bg-cyan-100 transition-colors" data-amount="${amount}">
                                        ${CONFIG.formatCount(amount)}
                                    </button>
                                `);
                            });
                        </script>
                    </div>
                </section>

                <section class="section-gap white-card p-5">
                    <h2 class="text-xs font-bold uppercase text-slate-500 tracking-wider mb-3">2. Withdrawal Summary</h2>
                    
                    <div class="col-stack gap-3 text-sm">
                        <div class="row-between">
                            <span class="text-slate-600">Withdrawal Fee (7%)</span>
                            <span class="text-red-500 font-bold">- ${CONFIG.CURRENCY_SYMBOL} <span id="fee-display">0.00</span></span>
                        </div>
                        <div class="row-between pt-3 border-t border-slate-100">
                            <span class="text-slate-800 font-bold">Net Payout Received</span>
                            <span class="text-green-600 font-extrabold text-lg">${CONFIG.CURRENCY_SYMBOL} <span id="net-received-display">0.00</span></span>
                        </div>
                    </div>

                    <p class="text-xs text-slate-500 mt-4">Note: Withdrawals are processed within 12-48 hours and are subject to the 7% fee.</p>
                </section>

                <button type="submit" id="withdraw-btn" class="btn btn-primary btn-block shadow-lg shadow-cyan-300 mb-4" disabled>
                    Request Withdrawal
                </button>
            </form>
        </main>

        <nav class="bottom-nav h-20">
            <div class="h-full row-between content-padding text-slate-400 text-xs font-medium">
                <div class="text-center w-1/5">
                    <a href="dashboard.html" class="flex flex-col items-center hover:text-cyan-400 transition-colors" data-transition>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                        <span class="mt-1">Home</span>
                    </a>
                </div>
                <div class="text-center w-1/5">
                    <a href="packages.html" class="flex flex-col items-center hover:text-cyan-400 transition-colors" data-transition>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"/></svg>
                        <span class="mt-1">Invest</span>
                    </a>
                </div>
                <div class="text-center w-1/5 -mt-6">
                    <a href="tasks-dashboard.html" class="nav-home-active flex-center shadow-lg shadow-cyan-300" data-transition>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    </a>
                </div>
                <div class="text-center w-1/5">
                    <a href="team-overview.html" class="flex flex-col items-center hover:text-cyan-400 transition-colors" data-transition>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        <span class="mt-1">Team</span>
                    </a>
                </div>
                <div class="text-center w-1/5">
                    <a href="profile.html" class="flex flex-col items-center hover:text-cyan-400 transition-colors" data-transition>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span class="mt-1">Me</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>
</body>
</html>
