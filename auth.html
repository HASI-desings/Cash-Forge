<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CashForge | Secure Access</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/style.css">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Auth-Specific Styles */
        body {
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; 
        }

        .glass-card {
            background: var(--glass-bg, rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.5));
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1);
            width: 100%; max-width: 400px;
            border-radius: 32px; padding: 32px;
            position: relative; overflow: hidden;
            transition: height 0.4s ease;
        }

        .input-group { position: relative; margin-bottom: 16px; transition: all 0.2s; }
        .input-icon {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; font-size: 20px; transition: color 0.2s;
        }
        
        .input-glass { padding-left: 48px; }
        .input-glass:focus + .input-icon { color: #008b8b; }
        
        .toggle-password {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; cursor: pointer; padding: 4px;
        }

        /* Liquid Form Slider */
        .form-slider {
            display: flex; width: 200%; transition: transform 0.5s ease;
        }
        .form-view { width: 50%; padding: 4px; opacity: 1; transition: opacity 0.3s ease; }
        .form-view.inactive { opacity: 0; pointer-events: none; }

        /* Password Strength Dots */
        .strength-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; transition: background 0.3s; }
        .strength-dot.active { background: #00FFFF; box-shadow: 0 0 10px #00FFFF; }
        
        /* Loader inside button */
        .btn-loading { pointer-events: none; opacity: 0.8; }
        .btn-loader {
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="bg-dots"></div>
    <div class="blob blob-1" style="top: -10%; left: -10%;"></div>
    <div class="blob blob-2" style="bottom: -10%; right: -10%;"></div>

    <main class="glass-card" id="main-card">
        
        <div class="text-center mb-6">
            <div class="relative h-24 w-full mx-auto mb-4 flex items-center justify-center">
                <div class="absolute w-20 h-20 bg-cyan-400/30 blur-2xl rounded-full animate-pulse-glow"></div>
                <img src="assets/images/logo.png" alt="CashForge" class="h-full w-auto object-contain relative z-10 drop-shadow-xl transform hover:scale-105 transition-transform duration-500"
                     onerror="this.style.display='none'; this.parentElement.innerHTML += '<div class=\'w-full h-full flex items-center justify-center bg-cyan-100 rounded-2xl text-cyan-800 font-bold text-3xl\'>CF</div>'">
            </div>
            
            <h1 class="heading-font text-2xl font-bold text-slate-800" id="auth-title">Welcome Back</h1>
            <p class="text-sm text-slate-500 mt-1" id="auth-subtitle">Secure access to your portfolio</p>
        </div>

        <div class="overflow-hidden">
            <div class="form-slider" id="slider">
                
                <div class="form-view" id="login-view">
                    <form id="login-form">
                        <div class="input-group">
                            <input type="email" id="login-email" class="input-glass" placeholder="Email Address" required>
                            <i class="ph-bold ph-envelope-simple input-icon"></i>
                        </div>
                        <div class="input-group">
                            <input type="password" id="login-pass" class="input-glass" placeholder="Password" required>
                            <i class="ph-bold ph-lock-key input-icon"></i>
                            <i class="ph-bold ph-eye toggle-password" onclick="window.togglePass('login-pass', this)"></i>
                        </div>
                        
                        <div class="flex justify-end mb-6">
                            <a href="#" class="text-xs font-bold text-cyan-600 hover:text-cyan-700">Forgot Password?</a>
                        </div>

                        <button type="submit" class="btn-primary" id="login-btn">
                            <span>Sign In</span> <i class="ph-bold ph-arrow-right"></i>
                        </button>
                    </form>

                    <div class="text-center mt-6">
                        <p class="text-sm text-slate-500">Don't have an account? <button type="button" onclick="window.switchMode('register')" class="text-cyan-600 font-bold hover:underline">Create one</button></p>
                    </div>
                </div>

                <div class="form-view inactive" id="register-view">
                    <form id="register-form">
                        <div class="input-group">
                            <input type="text" id="reg-name" class="input-glass" placeholder="Full Name" required>
                            <i class="ph-bold ph-user input-icon"></i>
                        </div>
                        <div class="input-group">
                            <input type="email" id="reg-email" class="input-glass" placeholder="Email Address" required>
                            <i class="ph-bold ph-envelope-simple input-icon"></i>
                        </div>
                        
                        <div class="input-group">
                            <input type="text" id="reg-ref" class="input-glass" placeholder="Referral Code (Optional)">
                            <i class="ph-bold ph-users-three input-icon"></i>
                        </div>

                        <div class="input-group mb-2">
                            <input type="password" id="reg-pass" class="input-glass" placeholder="Create Password" required oninput="window.checkStrength(this.value)">
                            <i class="ph-bold ph-lock-key input-icon"></i>
                            <i class="ph-bold ph-eye toggle-password" onclick="window.togglePass('reg-pass', this)"></i>
                        </div>
                        
                        <div class="flex gap-1 mb-6 pl-2">
                            <div class="strength-dot" id="dot-1"></div>
                            <div class="strength-dot" id="dot-2"></div>
                            <div class="strength-dot" id="dot-3"></div>
                            <span class="text-[10px] text-slate-400 ml-2" id="strength-text">Min 8 chars</span>
                        </div>

                        <button type="submit" class="btn-primary" id="reg-btn">
                            <span>Create Account</span> <i class="ph-bold ph-user-plus"></i>
                        </button>
                    </form>

                    <div class="text-center mt-6">
                        <p class="text-sm text-slate-500">Already have an account? <button type="button" onclick="window.switchMode('login')" class="text-cyan-600 font-bold hover:underline">Sign In</button></p>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <div id="toast" class="toast">
        <i class="ph-fill ph-check-circle text-lg"></i>
        <span id="toast-msg">Success</span>
    </div>

    <script type="module">
        // 1. IMPORT MODULES
        // Ensure these paths match your folder structure exactly!
        import { Auth } from './assets/js/auth.js';
        import { DB } from './assets/js/db.js';
        import { UI } from './assets/js/ui.js';

        console.log("Auth Script Loaded Successfully");

        // 2. ATTACH HELPERS TO WINDOW (So HTML onclick="..." works)
        window.switchMode = (mode) => {
            const slider = document.getElementById('slider');
            const loginView = document.getElementById('login-view');
            const regView = document.getElementById('register-view');
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');

            if (mode === 'register') {
                slider.style.transform = 'translateX(-50%)';
                loginView.classList.add('inactive');
                regView.classList.remove('inactive');
                title.innerText = "Join CashForge";
                subtitle.innerText = "Start your financial journey";
            } else {
                slider.style.transform = 'translateX(0)';
                loginView.classList.remove('inactive');
                regView.classList.add('inactive');
                title.innerText = "Welcome Back";
                subtitle.innerText = "Secure access to your portfolio";
            }
        };

        window.togglePass = (id, icon) => {
            const input = document.getElementById(id);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace('ph-eye', 'ph-eye-slash');
            } else {
                input.type = "password";
                icon.classList.replace('ph-eye-slash', 'ph-eye');
            }
        };

        window.checkStrength = (pass) => {
            const dot1 = document.getElementById('dot-1');
            const dot2 = document.getElementById('dot-2');
            const dot3 = document.getElementById('dot-3');
            const text = document.getElementById('strength-text');
            let score = 0;
            if (pass.length >= 8) score++;
            if (/\d/.test(pass)) score++;
            if (/[!@#$%^&*]/.test(pass)) score++;

            [dot1, dot2, dot3].forEach(d => d.className = 'strength-dot');
            if (score >= 1) { dot1.classList.add('active', 'bg-red-400'); text.innerText = "Weak"; }
            if (score >= 2) { dot2.classList.add('active', 'bg-yellow-400'); dot1.className = 'strength-dot active bg-yellow-400'; text.innerText = "Good"; }
            if (score === 3) { dot3.classList.add('active', 'bg-green-400'); dot1.className = 'strength-dot active bg-green-400'; dot2.className = 'strength-dot active bg-green-400'; text.innerText = "Strong"; }
        };

        // 3. AUTO-FILL REFERRAL CODE
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                const input = document.getElementById('reg-ref');
                if (input) input.value = refCode;
                window.switchMode('register');
            }
        };

        // 4. ATTACH FORM LISTENERS (This makes the buttons work)
        
        // LOGIN SUBMIT
        const loginForm = document.getElementById('login-form');
        if(loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Stop page reload
                
                const btn = document.getElementById('login-btn');
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;

                // Show Loading
                UI.setButtonLoading(btn, true);

                try {
                    const result = await Auth.signIn(email, pass);

                    if (result.success) {
                        UI.showToast("Login Successful!", "success");
                        setTimeout(() => window.location.href = 'home.html', 1000);
                    } else {
                        UI.setButtonLoading(btn, false); // Reset button
                        UI.showToast(result.message, "error");
                    }
                } catch (err) {
                    console.error(err);
                    UI.setButtonLoading(btn, false);
                    UI.showToast("Connection Error", "error");
                }
            });
        }

        // REGISTER SUBMIT
        const regForm = document.getElementById('register-form');
        if(regForm) {
            regForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const btn = document.getElementById('reg-btn');
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-pass').value;
                const refCode = document.getElementById('reg-ref').value;

                if (pass.length < 8) return UI.showToast("Password must be 8+ chars", "error");

                UI.setButtonLoading(btn, true);

                try {
                    // Call Auth
                    const result = await Auth.signUp(email, pass, name, refCode);

                    if (result.success) {
                        // Create Profile immediately as backup
                        await DB.createProfile(result.user.id, email, name, refCode);
                        
                        UI.showToast("Account Created! Signing in...", "success");
                        setTimeout(() => window.location.href = 'home.html', 1500);
                    } else {
                        UI.setButtonLoading(btn, false);
                        UI.showToast(result.message, "error");
                    }
                } catch (err) {
                    console.error(err);
                    UI.setButtonLoading(btn, false);
                    UI.showToast("Registration Error", "error");
                }
            });
        }
    </script>
</body>
</html>
